<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NettyServerHandler.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">site</a> &gt; <a href="index.source.html" class="el_package">com.hexagonkt.http.server.netty</a> &gt; <span class="el_source">NettyServerHandler.kt</span></div><h1>NettyServerHandler.kt</h1><pre class="source lang-java linenums">package com.hexagonkt.http.server.netty

import com.hexagonkt.http.bodyToBytes
import com.hexagonkt.http.model.*
import com.hexagonkt.http.server.handlers.PathHandler
import com.hexagonkt.http.server.model.HttpServerResponse
import io.netty.buffer.Unpooled
import io.netty.channel.ChannelFutureListener.CLOSE
import io.netty.channel.ChannelHandlerContext
import io.netty.channel.ChannelInboundHandlerAdapter
import io.netty.handler.codec.http.*
import io.netty.handler.codec.http.HttpHeaderNames.*
import io.netty.handler.codec.http.HttpHeaderValues.KEEP_ALIVE
import io.netty.handler.codec.http.HttpMethod
import io.netty.handler.codec.http.HttpResponseStatus.*
import io.netty.handler.codec.http.HttpVersion.HTTP_1_1
import io.netty.handler.codec.http.cookie.DefaultCookie
import io.netty.handler.codec.http.cookie.ServerCookieEncoder.STRICT
import io.netty.handler.codec.http.websocketx.WebSocketServerHandshakerFactory
import io.netty.handler.ssl.SslHandler
import io.netty.handler.ssl.SslHandshakeCompletionEvent
import java.lang.IllegalStateException
import java.net.InetSocketAddress
import java.security.cert.X509Certificate

<span class="fc" id="L26">internal class NettyServerHandler(</span>
<span class="fc" id="L27">    private val handlers: Map&lt;HttpMethod, PathHandler&gt;,</span>
<span class="fc" id="L28">    private val sslHandler: SslHandler?,</span>
<span class="fc" id="L29">) : ChannelInboundHandlerAdapter() {</span>

<span class="fc" id="L31">    private var certificates: List&lt;X509Certificate&gt; = emptyList()</span>

    override fun channelRead(context: ChannelHandlerContext, nettyRequest: Any) {
<span class="pc bpc" id="L34" title="1 of 2 branches missed.">        if (nettyRequest is FullHttpRequest) {</span>
<span class="fc" id="L35">            val result = nettyRequest.decoderResult()</span>

<span class="pc bpc" id="L37" title="1 of 2 branches missed.">            if (result.isFailure)</span>
<span class="nc" id="L38">                throw IllegalStateException(result.cause())</span>

<span class="fc" id="L40">            val channel = context.channel()</span>
<span class="fc" id="L41">            val address = channel.remoteAddress() as InetSocketAddress</span>
<span class="fc" id="L42">            val method = nettyRequest.method()</span>
<span class="fc" id="L43">            val headers = nettyRequest.headers()</span>
<span class="fc" id="L44">            val request = NettyRequestAdapter(method, nettyRequest, certificates, address, headers)</span>
<span class="pc bpc" id="L45" title="2 of 4 branches missed.">            val response = handlers[method]?.process(request) ?: HttpServerResponse()</span>

<span class="fc bfc" id="L47" title="All 2 branches covered.">            val connection = headers[CONNECTION]?.lowercase()</span>
<span class="fc bfc" id="L48" title="All 2 branches covered.">            val upgrade = headers[UPGRADE]?.lowercase()</span>

<span class="pc bpc" id="L50" title="1 of 4 branches missed.">            if (connection == &quot;upgrade&quot; &amp;&amp; upgrade == &quot;websocket&quot;) {</span>

                // Adding new handler to the existing pipeline to handle WebSocket Messages
<span class="fc" id="L53">                context.pipeline().replace(this, &quot;webSocketHandler&quot;, NettyWebSocketHandler())</span>

                // Do the Handshake to upgrade connection from HTTP to WebSocket protocol
<span class="fc" id="L56">                val host = headers[&quot;host&quot;]</span>
<span class="fc" id="L57">                val uri = nettyRequest.uri()</span>
<span class="fc" id="L58">                val url = &quot;ws://$host$uri&quot;</span>
<span class="fc" id="L59">                val wsFactory = WebSocketServerHandshakerFactory(url, null, true)</span>
<span class="fc" id="L60">                val handShaker = wsFactory.newHandshaker(nettyRequest)</span>

<span class="pc bpc" id="L62" title="1 of 2 branches missed.">                if (handShaker == null)</span>
<span class="nc" id="L63">                    WebSocketServerHandshakerFactory.sendUnsupportedVersionResponse(channel)</span>
                else
<span class="fc" id="L65">                    handShaker.handshake(channel, nettyRequest)</span>
            }
            else {
<span class="fc" id="L68">                writeResponse(context, response, HttpUtil.isKeepAlive(nettyRequest))</span>
            }
        }
<span class="fc" id="L71">    }</span>

    override fun userEventTriggered(ctx: ChannelHandlerContext, evt: Any) {
<span class="fc bfc" id="L74" title="All 4 branches covered.">        if (evt is SslHandshakeCompletionEvent &amp;&amp; sslHandler != null) {</span>
<span class="fc" id="L75">            val peerCertificates = sslHandler.engine().session.peerCertificates</span>
<span class="fc" id="L76">            certificates = peerCertificates.map { it as X509Certificate }</span>
        }
<span class="fc" id="L78">    }</span>

    @Suppress(&quot;OVERRIDE_DEPRECATION&quot;) // Deprecated in base interface, but allowed in parent class
    override fun exceptionCaught(context: ChannelHandlerContext, cause: Throwable) {
<span class="fc" id="L82">        val body = &quot;Failure: $cause\n&quot;</span>
<span class="fc" id="L83">        val response = HttpServerResponse(body, status = ServerErrorStatus.INTERNAL_SERVER_ERROR)</span>
<span class="fc" id="L84">        writeResponse(context, response, false)</span>
<span class="fc" id="L85">    }</span>

    private fun writeResponse(
        context: ChannelHandlerContext,
        hexagonResponse: HttpServerResponse,
        keepAlive: Boolean,
    ) {

<span class="fc" id="L93">        val buffer = Unpooled.copiedBuffer(bodyToBytes(hexagonResponse.body))</span>
<span class="fc" id="L94">        val status = nettyStatus(hexagonResponse.status)</span>
<span class="fc" id="L95">        val response = DefaultFullHttpResponse(HTTP_1_1, status, buffer)</span>
<span class="fc" id="L96">        val headers = response.headers()</span>

<span class="fc" id="L98">        val hexagonHeaders = hexagonResponse.headers</span>
<span class="fc bfc" id="L99" title="All 4 branches covered.">        if (hexagonHeaders.httpFields.isNotEmpty())</span>
<span class="fc" id="L100">            hexagonHeaders.allValues.map { (k, v) -&gt; headers.add(k, v) }</span>

<span class="fc" id="L102">        val hexagonCookies = hexagonResponse.cookies</span>
<span class="fc bfc" id="L103" title="All 4 branches covered.">        if (hexagonCookies.isNotEmpty())</span>
<span class="fc" id="L104">            headers[SET_COOKIE] = STRICT.encode(nettyCookies(hexagonCookies))</span>

<span class="fc" id="L106">        val contentType = hexagonResponse.contentType</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">        if (contentType != null)</span>
<span class="fc" id="L108">            headers[CONTENT_TYPE] = contentType.text</span>

<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (keepAlive) {</span>
<span class="fc" id="L111">            headers.setInt(CONTENT_LENGTH, response.content().readableBytes())</span>
<span class="fc" id="L112">            headers[CONNECTION] = KEEP_ALIVE</span>
<span class="fc" id="L113">            context.writeAndFlush(response)</span>
        }
        else {
<span class="fc" id="L116">            context.writeAndFlush(response).addListener(CLOSE)</span>
        }
<span class="fc" id="L118">    }</span>

    private fun nettyCookies(hexagonCookies: List&lt;HttpCookie&gt;) =
<span class="fc" id="L121">        hexagonCookies.map {</span>
<span class="fc" id="L122">            DefaultCookie(it.name, it.value).apply {</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">                if (it.maxAge != -1L)</span>
<span class="fc" id="L124">                    setMaxAge(it.maxAge)</span>
<span class="fc" id="L125">                isSecure = it.secure</span>
<span class="fc" id="L126">            }</span>
<span class="fc" id="L127">        }</span>

    internal fun nettyStatus(status: HttpStatus): HttpResponseStatus =
<span class="fc" id="L130">        when (status) {</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">            InformationStatus.CONTINUE -&gt; CONTINUE</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">            InformationStatus.SWITCHING_PROTOCOLS -&gt; SWITCHING_PROTOCOLS</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">            InformationStatus.PROCESSING -&gt; PROCESSING</span>

<span class="fc bfc" id="L135" title="All 2 branches covered.">            SuccessStatus.OK -&gt; OK</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">            SuccessStatus.CREATED -&gt; CREATED</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">            SuccessStatus.ACCEPTED -&gt; ACCEPTED</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">            SuccessStatus.NON_AUTHORITATIVE_INFORMATION -&gt; NON_AUTHORITATIVE_INFORMATION</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">            SuccessStatus.NO_CONTENT -&gt; NO_CONTENT</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">            SuccessStatus.RESET_CONTENT -&gt; RESET_CONTENT</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">            SuccessStatus.PARTIAL_CONTENT -&gt; PARTIAL_CONTENT</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">            SuccessStatus.MULTI_STATUS -&gt; MULTI_STATUS</span>

<span class="fc bfc" id="L144" title="All 2 branches covered.">            RedirectionStatus.MULTIPLE_CHOICES -&gt; MULTIPLE_CHOICES</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">            RedirectionStatus.MOVED_PERMANENTLY -&gt; MOVED_PERMANENTLY</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">            RedirectionStatus.FOUND -&gt; FOUND</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">            RedirectionStatus.SEE_OTHER -&gt; SEE_OTHER</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">            RedirectionStatus.NOT_MODIFIED -&gt; NOT_MODIFIED</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">            RedirectionStatus.USE_PROXY -&gt; USE_PROXY</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">            RedirectionStatus.TEMPORARY_REDIRECT -&gt; TEMPORARY_REDIRECT</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">            RedirectionStatus.PERMANENT_REDIRECT -&gt; PERMANENT_REDIRECT</span>

<span class="fc bfc" id="L153" title="All 2 branches covered.">            ClientErrorStatus.BAD_REQUEST -&gt; BAD_REQUEST</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">            ClientErrorStatus.NOT_FOUND -&gt; NOT_FOUND</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">            ClientErrorStatus.UNAUTHORIZED -&gt; UNAUTHORIZED</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">            ClientErrorStatus.PAYMENT_REQUIRED -&gt; PAYMENT_REQUIRED</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">            ClientErrorStatus.FORBIDDEN -&gt; FORBIDDEN</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">            ClientErrorStatus.METHOD_NOT_ALLOWED -&gt; METHOD_NOT_ALLOWED</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">            ClientErrorStatus.NOT_ACCEPTABLE -&gt; NOT_ACCEPTABLE</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">            ClientErrorStatus.PROXY_AUTHENTICATION_REQUIRED -&gt; PROXY_AUTHENTICATION_REQUIRED</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">            ClientErrorStatus.REQUEST_TIMEOUT -&gt; REQUEST_TIMEOUT</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">            ClientErrorStatus.CONFLICT -&gt; CONFLICT</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">            ClientErrorStatus.GONE -&gt; GONE</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">            ClientErrorStatus.LENGTH_REQUIRED -&gt; LENGTH_REQUIRED</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">            ClientErrorStatus.PRECONDITION_FAILED -&gt; PRECONDITION_FAILED</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">            ClientErrorStatus.URI_TOO_LONG -&gt; REQUEST_URI_TOO_LONG</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">            ClientErrorStatus.UNSUPPORTED_MEDIA_TYPE -&gt; UNSUPPORTED_MEDIA_TYPE</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">            ClientErrorStatus.RANGE_NOT_SATISFIABLE -&gt; REQUESTED_RANGE_NOT_SATISFIABLE</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">            ClientErrorStatus.EXPECTATION_FAILED -&gt; EXPECTATION_FAILED</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">            ClientErrorStatus.MISDIRECTED_REQUEST -&gt; MISDIRECTED_REQUEST</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">            ClientErrorStatus.UNPROCESSABLE_CONTENT -&gt; UNPROCESSABLE_ENTITY</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">            ClientErrorStatus.LOCKED -&gt; LOCKED</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">            ClientErrorStatus.FAILED_DEPENDENCY -&gt; FAILED_DEPENDENCY</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">            ClientErrorStatus.UPGRADE_REQUIRED -&gt; UPGRADE_REQUIRED</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">            ClientErrorStatus.PRECONDITION_REQUIRED -&gt; PRECONDITION_REQUIRED</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">            ClientErrorStatus.TOO_MANY_REQUESTS -&gt; TOO_MANY_REQUESTS</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">            ClientErrorStatus.REQUEST_HEADER_FIELDS_TOO_LARGE -&gt; REQUEST_HEADER_FIELDS_TOO_LARGE</span>

<span class="fc bfc" id="L179" title="All 2 branches covered.">            ServerErrorStatus.INTERNAL_SERVER_ERROR -&gt; INTERNAL_SERVER_ERROR</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">            ServerErrorStatus.NOT_IMPLEMENTED -&gt; NOT_IMPLEMENTED</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">            ServerErrorStatus.BAD_GATEWAY -&gt; BAD_GATEWAY</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">            ServerErrorStatus.SERVICE_UNAVAILABLE -&gt; SERVICE_UNAVAILABLE</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">            ServerErrorStatus.GATEWAY_TIMEOUT -&gt; GATEWAY_TIMEOUT</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">            ServerErrorStatus.HTTP_VERSION_NOT_SUPPORTED -&gt; HTTP_VERSION_NOT_SUPPORTED</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">            ServerErrorStatus.VARIANT_ALSO_NEGOTIATES -&gt; VARIANT_ALSO_NEGOTIATES</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">            ServerErrorStatus.INSUFFICIENT_STORAGE -&gt; INSUFFICIENT_STORAGE</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">            ServerErrorStatus.NOT_EXTENDED -&gt; NOT_EXTENDED</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">            ServerErrorStatus.NETWORK_AUTHENTICATION_REQUIRED -&gt; NETWORK_AUTHENTICATION_REQUIRED</span>

<span class="fc" id="L190">            else -&gt; HttpResponseStatus(status.code, status.toString())</span>
<span class="fc" id="L191">        }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>