<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InjectionManager.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hexagon_site</a> &gt; <a href="index.source.html" class="el_package">com.hexagonkt.injection</a> &gt; <span class="el_source">InjectionManager.kt</span></div><h1>InjectionManager.kt</h1><pre class="source lang-java linenums">package com.hexagonkt.injection

import com.hexagonkt.logging.Logger
import com.hexagonkt.helpers.eol
import kotlin.reflect.KClass

/**
 * Generators registry and utilities. This object keep tracks of supplier functions or specific
 * objects bound to classes. Different suppliers can be bound to the same type using 'tags'.
 */
object InjectionManager {

<span class="fc" id="L13">    internal val logger: Logger by lazy { Logger(this::class) }</span>

<span class="fc" id="L15">    internal var bindings: Map&lt;Target&lt;*&gt;, Provider&lt;*&gt;&gt; = emptyMap()</span>

    internal fun binding(key: Target&lt;*&gt;): String =
<span class="fc bfc" id="L18" title="All 2 branches covered.">        if (key.tag == Unit) key.type.toString()</span>
<span class="fc" id="L19">        else &quot;${key.type} with tag '${key.tag}'&quot;</span>

<span class="fc" id="L21">    fun &lt;T : Any, R : T&gt; bind(type: KClass&lt;T&gt;, provider: Provider&lt;R&gt;, tag: Any = Unit) {</span>
<span class="fc" id="L22">        val key = Target(type, tag)</span>

<span class="fc" id="L24">        val binding = binding(key)</span>
<span class="fc bfc" id="L25" title="All 2 branches covered.">        if (!bindings.containsKey(key)) {</span>
<span class="fc" id="L26">            bindings = bindings + (key to provider)</span>
<span class="fc" id="L27">            logger.info { &quot;$binding bound to function&quot; }</span>
        }
        else {
<span class="fc" id="L30">            logger.warn { &quot;$binding already bound (IGNORED). This should happen ONLY IN TEST&quot; }</span>
        }
<span class="fc" id="L32">    }</span>

<span class="nc" id="L34">    fun &lt;T : Any, R : T&gt; bind(type: KClass&lt;T&gt;, tag: Any = Unit, provider: () -&gt; R) {</span>
<span class="fc" id="L35">        bind(type, Generator(provider), tag)</span>
<span class="fc" id="L36">    }</span>

    fun &lt;T : Any, R : T&gt; bind(type: KClass&lt;T&gt;, provider: () -&gt; R) {
<span class="fc" id="L39">        bind(type, Generator(provider))</span>
<span class="fc" id="L40">    }</span>

<span class="nc" id="L42">    fun &lt;T : Any, R : T&gt; bind(type: KClass&lt;T&gt;, instance: R, tag: Any = Unit) {</span>
<span class="fc" id="L43">        bind(type, Instance(instance), tag)</span>
<span class="fc" id="L44">    }</span>

    fun &lt;T : Any, R : T&gt; bind(type: KClass&lt;T&gt;, instance: R) {
<span class="nc" id="L47">        bind(type, instance, Unit)</span>
<span class="nc" id="L48">    }</span>

    inline fun &lt;reified T : Any&gt; bind(tag: Any, noinline provider: () -&gt; T) =
        bind(T::class, Generator(provider), tag)

    inline fun &lt;reified T : Any&gt; bind(noinline provider: () -&gt; T) =
        bind(T::class, Generator(provider))

<span class="nc" id="L56">    inline fun &lt;reified T : Any&gt; bind(instance: T, tag: Any = Unit) =</span>
<span class="nc" id="L57">        bind(T::class, instance, tag)</span>

    fun &lt;T : Any, R : T&gt; bind(type: KClass&lt;T&gt;, providers: List&lt;() -&gt; R&gt;) {
<span class="fc" id="L60">        providers.forEachIndexed { ii, provider -&gt; bind(type, Generator(provider), ii) }</span>
<span class="fc" id="L61">    }</span>

    inline fun &lt;reified T : Any&gt; bind(providers: List&lt;() -&gt; T&gt;) {
        bind(T::class, providers)
    }

    fun &lt;T : Any, R : T&gt; bindSet(type: KClass&lt;T&gt;, instances: List&lt;R&gt;) {
<span class="fc" id="L68">        instances.forEachIndexed { ii, instance -&gt; bind(type, instance, ii) }</span>
<span class="fc" id="L69">    }</span>

    inline fun &lt;reified T : Any&gt; bindSet(instances: List&lt;T&gt;) {
        bindSet(T::class, instances)
    }

    fun &lt;T : Any, R : T&gt; bind(type: KClass&lt;T&gt;, providers: Map&lt;Any, () -&gt; R&gt;) {
<span class="fc" id="L76">        providers.forEach { (k, v) -&gt; bind(type, Generator(v), k) }</span>
<span class="fc" id="L77">    }</span>

    inline fun &lt;reified T : Any&gt; bind(providers: Map&lt;Any, () -&gt; T&gt;) {
        bind(T::class, providers)
    }

    fun &lt;T : Any, R : T&gt; bindSet(type: KClass&lt;T&gt;, instances: Map&lt;Any, R&gt;) {
<span class="fc" id="L84">        instances.forEach { (k, v) -&gt; bind(type, v, k) }</span>
<span class="fc" id="L85">    }</span>

    inline fun &lt;reified T : Any&gt; bindSet(instances: Map&lt;Any, T&gt;) {
        bindSet(T::class, instances)
    }

    @Suppress(&quot;UNCHECKED_CAST&quot;) // bind operation takes care of type matching
    fun &lt;T : Any&gt; injectOrNull(type: KClass&lt;T&gt;, tag: Any): T? =
<span class="fc bfc" id="L93" title="All 4 branches covered.">        bindings[Target(type, tag)]?.provide() as? T</span>

    @Suppress(&quot;UNCHECKED_CAST&quot;) // bind operation takes care of type matching
    fun &lt;T : Any&gt; injectList(type: KClass&lt;T&gt;): List&lt;T&gt; =
<span class="fc" id="L97">        bindings</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">            .filter { it.key.type == type }</span>
<span class="fc" id="L99">            .map { it.value.provide() as T }</span>

    @Suppress(&quot;UNCHECKED_CAST&quot;) // bind operation takes care of type matching
    fun &lt;T : Any&gt; injectMap(type: KClass&lt;T&gt;): Map&lt;Any, T&gt; =
<span class="fc" id="L103">        bindings</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">            .filter { it.key.type == type }</span>
<span class="fc" id="L105">            .map { it.key.tag to it.value.provide() as T }</span>
<span class="fc" id="L106">            .map { it.first to it.second }</span>
<span class="fc" id="L107">            .toMap()</span>

    @Suppress(&quot;UNCHECKED_CAST&quot;) // bind operation takes care of type matching
    fun &lt;T : Any&gt; inject(type: KClass&lt;T&gt;, tag: Any): T =
<span class="fc bfc" id="L111" title="All 2 branches covered.">        injectOrNull(type, tag) ?: error(&quot;${type.java.name} generator missing&quot;)</span>

    inline fun &lt;reified T : Any&gt; inject(tag: Any): T =
        inject(T::class, tag)

    fun &lt;T : Any&gt; inject(type: KClass&lt;T&gt;): T =
<span class="fc" id="L117">        inject(type, Unit)</span>

    inline fun &lt;reified T : Any&gt; inject(): T =
        inject(T::class)

    inline fun &lt;reified T : Any&gt; injectOrNull(tag: Any): T? =
        injectOrNull(T::class, tag)

    fun &lt;T : Any&gt; injectOrNull(type: KClass&lt;T&gt;): T? =
<span class="fc" id="L126">        injectOrNull(type, Unit)</span>

    inline fun &lt;reified T : Any&gt; injectOrNull(): T? =
        injectOrNull(T::class)

    override fun toString(): String =
<span class="fc" id="L132">        bindings</span>
<span class="fc" id="L133">            .map { it.key }</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">            .map { it.type.java.name to if (it.tag is Unit) &quot;&quot; else &quot; (${it.tag})&quot;}</span>
<span class="fc" id="L135">            .joinToString(eol, &quot;Bound classes with parameters:\n&quot;) {</span>
<span class="fc" id="L136">                &quot;\t * ${it.first}${it.second}&quot;</span>
<span class="fc" id="L137">            }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>