<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Call.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hexagon_site</a> &gt; <a href="index.source.html" class="el_package">com.hexagonkt.http.server</a> &gt; <span class="el_source">Call.kt</span></div><h1>Call.kt</h1><pre class="source lang-java linenums">package com.hexagonkt.http.server

import com.hexagonkt.helpers.CodedException
import com.hexagonkt.serialization.ContentType
import com.hexagonkt.serialization.SerializationFormat
import com.hexagonkt.serialization.SerializationManager
import com.hexagonkt.serialization.serialize
import java.nio.charset.Charset

/**
 * HTTP request context. It holds client supplied data and methods to change the response.
 *
 * TODO Move Request, Response and Session abstract methods here and pass the call to them
 */
<span class="fc" id="L15">class Call(val request: Request, val response: Response, val session: Session) {</span>

    /** Call attributes (for the current request). Same as HttpServletRequest.setAttribute(). */
    @Suppress(&quot;RemoveExplicitTypeArguments&quot;) // Without types fails inside IntelliJ
<span class="fc" id="L19">    val attributes: MutableMap&lt;String, Any&gt; by lazy { LinkedHashMap&lt;String, Any&gt;() }</span>

    val requestType: String get() =
<span class="fc" id="L22">        request.requestType()</span>

    val requestFormat: SerializationFormat get() =
<span class="fc" id="L25">        request.requestFormat()</span>

    val responseType: String get() =
<span class="fc bfc" id="L28" title="All 2 branches covered.">        response.contentType ?:</span>
<span class="pc bpc" id="L29" title="1 of 6 branches missed.">        request.accept?.let { if (it == &quot;*/*&quot;) null else it } ?:</span>
<span class="fc" id="L30">        requestType</span>

    val responseFormat: SerializationFormat get() =
<span class="fc" id="L33">        SerializationManager.formatOf(responseType)</span>

    // Request shortcuts
<span class="fc" id="L36">    val pathParameters: Map&lt;String, String&gt; by lazy { request.pathParameters }</span>
<span class="fc" id="L37">    val queryParametersValues: Map&lt;String, List&lt;String&gt;&gt; by lazy { request.queryParametersValues }</span>
<span class="fc" id="L38">    val formParametersValues: Map&lt;String, List&lt;String&gt;&gt; by lazy { request.formParametersValues }</span>
<span class="fc" id="L39">    val queryParameters: Map&lt;String, String&gt; by lazy { request.queryParameters }</span>
<span class="pc" id="L40">    val formParameters: Map&lt;String, String&gt; by lazy { request.formParameters }</span>

    /**
     * Sends success response with given content type.
     *
     * @param content Content of the response.
     * @param contentType Content type of the response.
     */
<span class="pc" id="L48">    fun ok(content: Any = &quot;&quot;, contentType: String? = null) = send(200, content, contentType)</span>

    /**
     * Sends success response serialized using given [SerializationFormat] and [Charset].
     *
     * @param content Content of the response.
     * @param serializationFormat Serialization format for serializing the response.
     * @param charset Character Set to be used for the content type.
     */
    fun ok(
        content: Any,
<span class="fc" id="L59">        serializationFormat: SerializationFormat = responseFormat,</span>
<span class="fc" id="L60">        charset: Charset? = null) =</span>
<span class="fc" id="L61">            send(200, content, serializationFormat, charset)</span>

    /**
     * Sends response to the client.
     *
     * @param code Status code of the response.
     * @param content Content of the response.
     * @param contentType Content type of the response.
     */
<span class="fc" id="L70">    fun send(code: Int, content: Any = &quot;&quot;, contentType: String? = null) {</span>
<span class="fc" id="L71">        response.status = code</span>
<span class="fc" id="L72">        response.body = content</span>

<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (contentType != null)</span>
<span class="fc" id="L75">            response.contentType = contentType</span>
<span class="fc" id="L76">    }</span>

    /**
     * Sends response to the client after serializing using given [SerializationFormat]
     * and [Charset].
     *
     * @param code Status code of the response.
     * @param content Content of the response.
     * @param serializationFormat Serialization format for serializing the response.
     * @param charset Character Set to be used for the content type.
     */
    fun send(code: Int, content: Any, serializationFormat: SerializationFormat, charset: Charset?) {
<span class="fc" id="L88">        send(code, content, ContentType(serializationFormat, charset))</span>
<span class="fc" id="L89">    }</span>

    /**
     * Sends response to the client after serializing using given [ContentType] instance.
     *
     * @param code Status code of the response.
     * @param content Content of the response.
     * @param contentType Content type of the response.
     */
    // TODO Handle charset: transform content to the proper encoding
    fun send(code: Int, content: Any, contentType: ContentType) =
<span class="fc" id="L100">        send(code, content.serialize(contentType.format), contentType.toString())</span>

    /**
     * Sends error response.
     *
     * @param content Message for error response.
     */
    fun halt(content: Any): Nothing =
<span class="nc" id="L108">        halt(500, content)</span>

    /**
     * Sends error response.
     *
     * @param code Status code for error response.
     * @param content Message for error response.
     */
<span class="pc" id="L116">    fun halt(code: Int = 500, content: Any = &quot;&quot;): Nothing {</span>
<span class="fc" id="L117">        throw CodedException(code, content.toString())</span>
    }

    /**
     * Sends a redirect response to the client using the
     * specified redirect URL.
     *
     * @param url Redirect URL.
     */
    fun redirect(url: String) {
<span class="fc" id="L127">        response.redirect(url)</span>
<span class="fc" id="L128">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>