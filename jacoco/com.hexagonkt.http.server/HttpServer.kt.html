<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HttpServer.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">site</a> &gt; <a href="index.source.html" class="el_package">com.hexagonkt.http.server</a> &gt; <span class="el_source">HttpServer.kt</span></div><h1>HttpServer.kt</h1><pre class="source lang-java linenums">package com.hexagonkt.http.server

import com.hexagonkt.core.logging.Logger
import com.hexagonkt.core.Jvm.charset
import com.hexagonkt.core.Jvm.cpuCount
import com.hexagonkt.core.Jvm.hostname
import com.hexagonkt.core.Jvm.ip
import com.hexagonkt.core.Jvm.name
import com.hexagonkt.core.Jvm.version
import com.hexagonkt.core.Jvm.localeCode
import com.hexagonkt.core.Jvm.timezone
import com.hexagonkt.http.model.HttpProtocol.HTTP2
import com.hexagonkt.http.model.HttpProtocol.HTTP

import java.lang.Runtime.getRuntime
import com.hexagonkt.core.Ansi.BLUE
import com.hexagonkt.core.Ansi.BOLD
import com.hexagonkt.core.Ansi.CYAN
import com.hexagonkt.core.Ansi.DEFAULT
import com.hexagonkt.core.Ansi.MAGENTA
import com.hexagonkt.core.Ansi.RESET
import com.hexagonkt.core.Ansi.UNDERLINE
import com.hexagonkt.core.Jvm.initialMemory
import com.hexagonkt.core.Jvm.uptime
import com.hexagonkt.core.Jvm.usedMemory
import com.hexagonkt.core.prependIndent
import com.hexagonkt.http.server.HttpServerFeature.ZIP
import com.hexagonkt.http.server.handlers.HttpHandler
import com.hexagonkt.http.server.handlers.ServerBuilder
import com.hexagonkt.http.server.handlers.path
import java.io.Closeable
import java.lang.System.nanoTime

/**
 * Server that listen to HTTP connections on a port and address and route requests to handlers.
 */
<span class="pc" id="L37">data class HttpServer(</span>
<span class="fc" id="L38">    private val adapter: HttpServerPort,</span>
<span class="fc" id="L39">    val handlers: List&lt;HttpHandler&gt;,</span>
<span class="pc" id="L40">    val settings: HttpServerSettings = HttpServerSettings()</span>
) : Closeable {

    companion object {
<span class="fc" id="L44">        val banner: String = &quot;&quot;&quot;</span>
        $CYAN          _________
        $CYAN         /         \
        $CYAN        /   ____   /
        $CYAN       /   /   /  /
        $CYAN      /   /   /__/$BLUE   /\$BOLD    H E X A G O N$RESET
        $CYAN     /   /$BLUE          /  \$DEFAULT        ___
        $CYAN     \  /$BLUE   ___    /   /
        $CYAN      \/$BLUE   /  /   /   /$CYAN    T O O L K I T$RESET
        $BLUE          /  /___/   /
        $BLUE         /          /
        $BLUE         \_________/       https://hexagonkt.com/http_server
        $RESET
<span class="fc" id="L57">        &quot;&quot;&quot;.trimIndent()</span>
    }

<span class="fc" id="L60">    private val logger: Logger = Logger(this::class)</span>

    /**
     * Create a server with a builder ([ServerBuilder]) to set up handlers.
     *
     * @param adapter The server engine.
     * @param settings Server settings. Port and address will be searched in this map.
     * @param block Handlers' setup block.
     * @return A new server with the configured handlers.
     */
<span class="fc" id="L70">    constructor(</span>
        adapter: HttpServerPort,
<span class="fc" id="L72">        settings: HttpServerSettings = HttpServerSettings(),</span>
        block: ServerBuilder.() -&gt; Unit
    ) :
<span class="fc" id="L75">        this(adapter, listOf(path(block = block)), settings)</span>

    /**
     * Utility constructor for the common case of having a single root handler.
     *
     * @param adapter The server engine.
     * @param handler The only handler used for this server.
     * @param settings Server settings. Port and address will be searched in this map.
     */
<span class="nc" id="L84">    constructor(</span>
        adapter: HttpServerPort,
        handler: HttpHandler,
<span class="nc" id="L87">        settings: HttpServerSettings = HttpServerSettings(),</span>
<span class="pc" id="L88">    ) : this(adapter, listOf(handler), settings)</span>

    override fun close() {
<span class="fc" id="L91">        stop()</span>
<span class="fc" id="L92">    }</span>

<span class="fc" id="L94">    init {</span>
<span class="fc" id="L95">        val supportedProtocols = adapter.supportedProtocols()</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">        check(settings.protocol in supportedProtocols) {</span>
<span class="fc" id="L97">            val supportedProtocolsText = supportedProtocols.joinToString(&quot;, &quot;)</span>
<span class="fc" id="L98">            &quot;Requesting unsupported protocol. Adapter's protocols: $supportedProtocolsText&quot;</span>
        }

<span class="fc bfc" id="L101" title="All 2 branches covered.">        if (settings.zip)</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">            check(adapter.supportedFeatures().contains(ZIP)) {</span>
<span class="fc" id="L103">                val adapterName = adapter::class.qualifiedName</span>
<span class="fc" id="L104">                &quot;Requesting ZIP compression with an adapter without support: '$adapterName'&quot;</span>
            }
<span class="fc" id="L106">    }</span>

    /**
     * Runtime port of the server.
     *
     * @exception IllegalStateException Throw an exception if the server hasn't been started.
     */
    val runtimePort
<span class="fc bfc" id="L114" title="All 2 branches covered.">        get() = if (started()) adapter.runtimePort() else error(&quot;Server is not running&quot;)</span>

    /**
     * The port name of the server.
     */
<span class="fc" id="L119">    val portName: String = adapter.javaClass.simpleName</span>

    /**
     * Check whether the server has been started.
     *
     * @return True if the server has started, else false.
     */
    fun started(): Boolean =
<span class="fc" id="L127">        adapter.started()</span>

    /**
     * Start the server with the adapter instance and adds a shutdown hook for stopping the server.
     */
    fun start() {
<span class="fc" id="L133">        val startTimestamp = nanoTime()</span>

<span class="fc" id="L135">        getRuntime().addShutdownHook(</span>
<span class="fc" id="L136">            Thread(</span>
                {
<span class="fc bfc" id="L138" title="All 2 branches covered.">                    if (started())</span>
<span class="fc" id="L139">                        adapter.shutDown()</span>
<span class="fc" id="L140">                },</span>
<span class="fc" id="L141">                &quot;shutdown-${settings.bindAddress.hostName}-${settings.bindPort}&quot;</span>
            )
        )

<span class="fc" id="L145">        adapter.startUp(this)</span>
<span class="fc" id="L146">        logger.info { &quot;Server started\n${createBanner(nanoTime() - startTimestamp)}&quot; }</span>
<span class="fc" id="L147">    }</span>

    /**
     * Stop the server.
     */
    fun stop() {
<span class="fc" id="L153">        adapter.shutDown()</span>
<span class="fc" id="L154">        logger.info { &quot;Server stopped&quot; }</span>
<span class="fc" id="L155">    }</span>

    internal fun createBanner(startUpTimestamp: Long): String {

<span class="fc" id="L159">        val startUpTime = &quot;%,.0f&quot;.format(startUpTimestamp / 1e6)</span>
<span class="fc" id="L160">        val bindAddress = settings.bindAddress</span>
<span class="fc" id="L161">        val protocol = settings.protocol</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">        val hostName = if (bindAddress.isAnyLocalAddress) ip else bindAddress.canonicalHostName</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">        val scheme = if (protocol == HTTP) &quot;http&quot; else &quot;https&quot;</span>
<span class="fc" id="L164">        val binding = &quot;$scheme://$hostName:$runtimePort&quot;</span>

<span class="fc" id="L166">        val serverAdapterValue = &quot;$BOLD$CYAN$portName$RESET&quot;</span>

<span class="fc" id="L168">        val protocols = adapter.supportedProtocols()</span>
<span class="fc" id="L169">            .joinToString(&quot;$RESET, $CYAN&quot;, CYAN, RESET) {</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">                if (it == settings.protocol) &quot;✅$it&quot; else &quot;$it&quot;</span>
            }

<span class="fc" id="L173">        val features = adapter.supportedFeatures()</span>
<span class="fc" id="L174">            .joinToString(&quot;$RESET, $CYAN&quot;, CYAN, RESET) { it.toString() }</span>

<span class="fc" id="L176">        val options = adapter.options()</span>
<span class="fc" id="L177">            .map { (k, v) -&gt; &quot;$k($v)&quot; }</span>
<span class="fc" id="L178">            .joinToString(&quot;$RESET, $CYAN&quot;, CYAN, RESET)</span>

<span class="fc" id="L180">        val hostnameValue = &quot;$BLUE$hostname$RESET&quot;</span>
<span class="fc" id="L181">        val cpuCountValue = &quot;$BLUE$cpuCount$RESET&quot;</span>
<span class="fc" id="L182">        val jvmMemoryValue = &quot;$BLUE${initialMemory()}$RESET&quot;</span>

<span class="fc" id="L184">        val javaVersionValue = &quot;$BOLD${BLUE}Java $version$RESET [$BLUE$name$RESET]&quot;</span>

<span class="fc" id="L186">        val localeValue = &quot;$BLUE$localeCode$RESET&quot;</span>
<span class="fc" id="L187">        val timezoneValue = &quot;$BLUE$timezone$RESET&quot;</span>
<span class="fc" id="L188">        val charsetValue = &quot;$BLUE$charset$RESET&quot;</span>

<span class="fc" id="L190">        val bootTimeValue = &quot;$BOLD$MAGENTA${uptime()} s$RESET&quot;</span>
<span class="fc" id="L191">        val startUpTimeValue = &quot;$BOLD$MAGENTA$startUpTime ms$RESET&quot;</span>
<span class="fc" id="L192">        val usedMemoryValue = &quot;$BOLD$MAGENTA${usedMemory()} KB$RESET&quot;</span>
<span class="fc" id="L193">        val bindingValue = &quot;$BLUE$UNDERLINE$binding$RESET&quot;</span>

<span class="fc" id="L195">        val information = &quot;&quot;&quot;</span>

<span class="fc" id="L197">            Server Adapter: $serverAdapterValue ($protocols)</span>
<span class="fc" id="L198">            Supported Features: $features</span>
<span class="fc" id="L199">            Configuration Options: $options</span>

<span class="fc" id="L201">            🖥️️ Running in '$hostnameValue' with $cpuCountValue CPUs $jvmMemoryValue KB</span>
<span class="fc" id="L202">            🛠 Using $javaVersionValue</span>
<span class="fc" id="L203">            🌍 Locale: $localeValue Timezone: $timezoneValue Charset: $charsetValue</span>

<span class="fc" id="L205">            ⏱️ Started in $bootTimeValue (server: $startUpTimeValue) using $usedMemoryValue</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">            🚀 Served at $bindingValue${if (protocol == HTTP2) &quot; (HTTP/2)&quot; else &quot;&quot; }</span>

<span class="fc" id="L208">        &quot;&quot;&quot;.trimIndent()</span>

<span class="pc bpc" id="L210" title="1 of 4 branches missed.">        val banner = (settings.banner?.let { &quot;$it\n&quot; } ?: banner) + information</span>
<span class="fc" id="L211">        return banner.prependIndent()</span>
    }
<span class="nc" id="L213">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>