<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Request.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hexagon_site</a> &gt; <a href="index.source.html" class="el_package">com.hexagonkt.http.server</a> &gt; <span class="el_source">Request.kt</span></div><h1>Request.kt</h1><pre class="source lang-java linenums">package com.hexagonkt.http.server

import com.hexagonkt.http.Cookie
import com.hexagonkt.http.Method
import com.hexagonkt.http.Part
import com.hexagonkt.serialization.SerializationFormat
import com.hexagonkt.serialization.SerializationManager
import com.hexagonkt.serialization.SerializationManager.requireDefaultFormat
import com.hexagonkt.serialization.parse
import com.hexagonkt.serialization.parseObjects
import java.security.cert.X509Certificate
import kotlin.reflect.KClass

/**
 * Lists would be initialized loading all elements when they are used (set it as lazy in
 * implementations) this will have a performance penalty in favor of ease of use. The alternative
 * would be using a 'Map/List wrapper that delegates calls to abstract methods in the interface
 * (I won't do this just now).
 *
 * HTTP request context. It holds client supplied data and methods to change the response.
 */
<span class="fc" id="L22">class Request(adapter: RequestPort) {</span>

    /**
     * Provides the HTTP method of the request.
     */
<span class="fc" id="L27">    val method: Method by lazy { adapter.method() }</span>

    /**
     * Provides the name of the scheme used to make this request.
     */
<span class="fc" id="L32">    val scheme: String by lazy { adapter.scheme() }</span>

    /**
     * Provides the fully qualified name of the client.
     */
<span class="fc" id="L37">    val host: String by lazy { adapter.host() }</span>

    /**
     * Provides the client IP address.
     */
<span class="fc" id="L42">    val ip: String by lazy { adapter.ip() }</span>

    /**
     * Provides the port number used to make the request.
     */
<span class="fc" id="L47">    val port: Int by lazy { adapter.port() }</span>

    /**
     * Provides the servlet path of the request.
     */
<span class="fc" id="L52">    val path: String by lazy { adapter.path() }</span>

    /**
     * Provides the query string of the request.
     */
<span class="fc" id="L57">    val queryString: String by lazy { adapter.queryString() }</span>

    /**
     * Provides the URL client used to make the request.
     */
<span class="fc" id="L62">    val url: String by lazy { adapter.url() }</span>

    /**
     * Provides a [Map] of multipart parts in the request.
     */
<span class="fc" id="L67">    val parts: Map&lt;String, Part&gt; by lazy { adapter.parts() }</span>

    /**
     * Provides [Map] of parsed key-value pairs of query parameters in the request.
     */
<span class="fc" id="L72">    val queryParametersValues: Map&lt;String, List&lt;String&gt;&gt; by lazy { adapter.queryParameters() }</span>

    /**
     * Provides [Map] of request parameters contained in form fields.
     */
<span class="fc" id="L77">    val formParametersValues: Map&lt;String, List&lt;String&gt;&gt; by lazy { adapter.formParameters() }</span>

    /**
     * Provides a [Map] of first values of all query parameters in the request.
     */
<span class="fc" id="L82">    val queryParameters: Map&lt;String, String&gt; by lazy { firsts(queryParametersValues) }</span>

    /**
     * Provides a [Map] of first values of all form fields.
     */
<span class="fc" id="L87">    val formParameters: Map&lt;String, String&gt; by lazy { firsts(formParametersValues) }</span>

    /**
     * Provides a [Map] of all path parameters.
     */
<span class="fc" id="L92">    val pathParameters: Map&lt;String, String&gt; by lazy { adapter.pathParameters() }</span>

    /**
     * Provides a [List] of certificate chain used for SSL.
     */
<span class="fc" id="L97">    val certificateChain: List&lt;X509Certificate&gt; by lazy { adapter.certificateChain() }</span>

    /**
     * Check if the request is secure.
     */
<span class="fc" id="L102">    val secure: Boolean by lazy { scheme == &quot;https&quot; }</span>

    /**
     * [List] of parameters for &quot;Accept&quot; header key.
     */
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">    val acceptValues: List&lt;String&gt; by lazy { headersValues[&quot;Accept&quot;] ?: emptyList() }</span>

    /**
     * First value in &quot;Accept&quot; header key.
     */
<span class="fc" id="L112">    val accept: String? by lazy { acceptValues.firstOrNull() }</span>

    /**
     * Preferred content-type specified under &quot;Accept&quot; header key.
     */
<span class="fc" id="L117">    val preferredType: String? by lazy { accept }</span>

    /**
     * First value of &quot;User-Agent&quot; header key.
     */
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">    val userAgent: String? by lazy { headersValues[&quot;User-Agent&quot;]?.firstOrNull() }</span>

    /**
     * First value of &quot;Referer&quot; header key.
     */
<span class="fc bfc" id="L127" title="All 2 branches covered.">    val referer: String? by lazy { headersValues[&quot;Referer&quot;]?.firstOrNull() }</span>

    /**
     * First value of &quot;Origin&quot; header key.
     */
<span class="fc bfc" id="L132" title="All 2 branches covered.">    val origin: String? by lazy { headersValues[&quot;Origin&quot;]?.firstOrNull() }</span>

    /**
     * First certificate in the [certificateChain].
     */
<span class="fc" id="L137">    val certificate: X509Certificate? by lazy { certificateChain.firstOrNull() }</span>

    /**
     * Request body sent by the client.
     */
<span class="fc" id="L142">    val body: String by lazy { adapter.loadBody() }</span>

    /**
     * [Map] of header values of the request.
     */
<span class="fc" id="L147">    val headersValues: Map&lt;String, List&lt;String&gt;&gt; by lazy { adapter.headers() }</span>

    /**
     * [Map] of first values of the headers of the request.
     */
<span class="fc" id="L152">    val headers: Map&lt;String, String&gt; by lazy { firsts(headersValues) }</span>

    /**
     * [Map] of the cookies contained in the browser.
     */
<span class="fc" id="L157">    val cookies: Map&lt;String, Cookie&gt; by lazy { adapter.cookies() }</span>

    /**
     * Content type of the request body.
     */
<span class="fc" id="L162">    val contentType: String? by lazy { adapter.contentType() }</span>

    /**
     * Length of the request body.
     */
<span class="fc" id="L167">    val contentLength: Long by lazy { adapter.contentLength() }</span>

    /**
     * Parses request body according to given [type].
     *
     * @param type Class specifying the type to which the body is to be parsed
     */
<span class="fc" id="L174">    fun &lt;T : Any&gt; body(type: KClass&lt;T&gt;): T = body.parse(type, requestFormat())</span>

    /**
     * Parses request body objects to given [type].
     *
     * @param type Class specifying the type to which the objects are to be parsed
     */
<span class="fc" id="L181">    fun &lt;T : Any&gt; bodyObjects(type: KClass&lt;T&gt;): List&lt;T&gt; = body.parseObjects(type, requestFormat())</span>

    /** Parses request body. */
    inline fun &lt;reified T : Any&gt; body(): T = body(T::class)

    /** Parses request body objects. */
    inline fun &lt;reified T : Any&gt; bodyObjects(): List&lt;T&gt; = bodyObjects(T::class)

    internal fun requestType(): String =
<span class="fc bfc" id="L190" title="All 2 branches covered.">        contentType ?: requireDefaultFormat().contentType</span>

    internal fun requestFormat(): SerializationFormat =
<span class="fc" id="L193">        SerializationManager.formatOf(requestType())</span>

    private fun &lt;K, V&gt; firsts(map: Map&lt;K, List&lt;V&gt;&gt;): Map&lt;K, V&gt; =
<span class="fc" id="L196">        map.mapValues { it.value.first() }</span>

    /**
     * Aggregates path parameters, form parameters and query parameters into a map.
     *
     * @return an object of type T  (eg: MyCustomDataClass()).
     */
    fun allParameters(): Map&lt;String, Any&gt; =
<span class="fc" id="L204">        transformValues(this.formParametersValues) +</span>
<span class="fc" id="L205">        transformValues(this.queryParametersValues) +</span>
<span class="fc" id="L206">        this.pathParameters</span>

    /**
     * Function will check the list of values against each key. Returns the value alone if the list
     * size is 1 else returns the entire list as is.
     *
     * @param stringToListMap : Map&lt;String,List&lt;String&gt;&gt; type
     * @return stringToAnyMap : Map&lt;String,Any&gt; type
     */
    private fun transformValues(stringToListMap: Map&lt;String, List&lt;String&gt;&gt;): Map&lt;String, Any&gt; {
<span class="fc" id="L216">        val stringToAnyMap = mutableMapOf&lt;String, Any&gt;()</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">        for (queryParameter in stringToListMap.entries) {</span>
<span class="fc" id="L218">            val value: Any = when (queryParameter.value.size) {</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">                1 -&gt; queryParameter.value.first()</span>
<span class="fc" id="L220">                else -&gt; queryParameter.value</span>
            }
<span class="fc" id="L222">            stringToAnyMap[queryParameter.key] = value</span>
        }
<span class="fc" id="L224">        return stringToAnyMap</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>