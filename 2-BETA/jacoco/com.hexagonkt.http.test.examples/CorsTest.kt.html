<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CorsTest.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">site</a> &gt; <a href="index.source.html" class="el_package">com.hexagonkt.http.test.examples</a> &gt; <span class="el_source">CorsTest.kt</span></div><h1>CorsTest.kt</h1><pre class="source lang-java linenums">package com.hexagonkt.http.test.examples

import com.hexagonkt.core.helpers.multiMapOf
import com.hexagonkt.core.helpers.multiMapOfLists
import com.hexagonkt.http.client.HttpClientPort
import com.hexagonkt.http.model.ClientErrorStatus.FORBIDDEN
import com.hexagonkt.http.model.HttpMethod.POST
import com.hexagonkt.http.model.SuccessStatus.NO_CONTENT
import com.hexagonkt.http.model.SuccessStatus.OK
import com.hexagonkt.http.server.*
import com.hexagonkt.http.server.callbacks.CorsCallback
import com.hexagonkt.http.server.handlers.PathBuilder
import com.hexagonkt.http.server.handlers.PathHandler
import com.hexagonkt.http.server.handlers.ServerHandler
import com.hexagonkt.http.server.handlers.path
import com.hexagonkt.http.test.BaseTest
import kotlinx.coroutines.runBlocking
import org.junit.jupiter.api.Test
import kotlin.test.assertEquals

@Suppress(&quot;FunctionName&quot;) // This class's functions are intended to be used only in tests
<span class="fc" id="L22">abstract class CorsTest(</span>
<span class="fc" id="L23">    override val clientAdapter: () -&gt; HttpClientPort,</span>
<span class="fc" id="L24">    override val serverAdapter: () -&gt; HttpServerPort</span>
<span class="fc" id="L25">) : BaseTest() {</span>

    // cors
<span class="pc" id="L28">    val path: PathHandler = path {</span>
<span class="fc" id="L29">        corsPath(&quot;/default&quot;, CorsCallback())</span>
<span class="fc" id="L30">        corsPath(&quot;/example/org&quot;, CorsCallback(&quot;example.org&quot;))</span>
<span class="fc" id="L31">        corsPath(&quot;/no/credentials&quot;, CorsCallback(supportCredentials = false))</span>
<span class="fc" id="L32">        corsPath(&quot;/only/post&quot;, CorsCallback(allowedMethods = setOf(POST)))</span>
<span class="fc" id="L33">        corsPath(&quot;/cache&quot;, CorsCallback(preFlightMaxAge = 10))</span>
<span class="fc" id="L34">        corsPath(&quot;/exposed/headers&quot;, CorsCallback(exposedHeaders = setOf(&quot;head&quot;)))</span>
<span class="fc" id="L35">        corsPath(&quot;/allowed/headers&quot;, CorsCallback(allowedHeaders = setOf(&quot;head&quot;)))</span>
<span class="fc" id="L36">    }</span>

    private fun PathBuilder.corsPath(path: String, settings: CorsCallback) {
<span class="fc" id="L39">        path(path) {</span>
            // CORS settings can change for different routes
<span class="fc" id="L41">            filter(pattern = &quot;/?*&quot;, callback = settings)</span>

<span class="pc bpc" id="L43" title="1 of 2 branches missed.">            get(&quot;/path&quot;) { ok(request.method.toString()) }</span>
<span class="pc bnc" id="L44" title="All 2 branches missed.">            post(&quot;/path&quot;) { ok(request.method.toString()) }</span>
<span class="pc bnc" id="L45" title="All 2 branches missed.">            put(&quot;/path&quot;) { ok(request.method.toString()) }</span>
<span class="pc bnc" id="L46" title="All 2 branches missed.">            delete(&quot;/path&quot;) { ok(request.method.toString()) }</span>
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">            get { ok(request.method.toString()) }</span>
<span class="pc bnc" id="L48" title="All 2 branches missed.">            post { ok(request.method.toString()) }</span>
<span class="pc bnc" id="L49" title="All 2 branches missed.">            put { ok(request.method.toString()) }</span>
<span class="pc bnc" id="L50" title="All 2 branches missed.">            delete { ok(request.method.toString()) }</span>
<span class="fc" id="L51">        }</span>
<span class="fc" id="L52">    }</span>
    // cors

<span class="fc" id="L55">    override val handlers: List&lt;ServerHandler&gt; = listOf(path)</span>

<span class="fc" id="L57">    @Test fun `Request without origin continues as non CORS`() = runBlocking {</span>
<span class="fc" id="L58">        listOf(</span>
<span class="fc" id="L59">            client.get(&quot;/default&quot;),</span>
<span class="fc" id="L60">            client.get(&quot;/default/path&quot;)</span>
<span class="fc" id="L61">        ).forEach {</span>
<span class="fc" id="L62">            assertEquals(OK, it.status)</span>
<span class="fc" id="L63">            assertEquals(&quot;GET&quot;, it.body)</span>
<span class="fc" id="L64">        }</span>
<span class="fc" id="L65">    }</span>

<span class="fc" id="L67">    @Test fun `Request with not allowed origin is forbidden`() = runBlocking {</span>
<span class="fc" id="L68">        listOf(</span>
<span class="fc" id="L69">            client.get(&quot;/example/org&quot;, multiMapOf(&quot;origin&quot; to &quot;other.com&quot;)),</span>
<span class="fc" id="L70">            client.get(&quot;/example/org/path&quot;, multiMapOf(&quot;origin&quot; to &quot;other.com&quot;))</span>
<span class="fc" id="L71">        ).forEach {</span>
<span class="fc" id="L72">            assertEquals(FORBIDDEN, it.status)</span>
<span class="fc" id="L73">            assertEquals(&quot;Not allowed origin: other.com&quot;, it.body)</span>
<span class="fc" id="L74">        }</span>
<span class="fc" id="L75">    }</span>

<span class="fc" id="L77">    @Test fun `Allowed origin is returned properly`() = runBlocking {</span>
<span class="fc" id="L78">        listOf(</span>
<span class="fc" id="L79">            client.get(&quot;/no/credentials&quot;, multiMapOf(&quot;origin&quot; to &quot;other.com&quot;)),</span>
<span class="fc" id="L80">            client.get(&quot;/no/credentials/path&quot;, multiMapOf(&quot;origin&quot; to &quot;other.com&quot;))</span>
<span class="fc" id="L81">        ).forEach {</span>
<span class="fc" id="L82">            assertEquals(OK, it.status)</span>
<span class="fc" id="L83">            assertEquals(&quot;GET&quot;, it.body)</span>
<span class="fc" id="L84">            assertEquals(&quot;*&quot;, it.headers[&quot;access-control-allow-origin&quot;])</span>
<span class="pc bpc" id="L85" title="5 of 8 branches missed.">            assert(it.headers[&quot;vary&quot;]?.contains(&quot;Origin&quot;)?.not() ?: true)</span>
<span class="fc" id="L86">        }</span>
<span class="fc" id="L87">    }</span>

<span class="fc" id="L89">    @Test fun `Simple CORS request`() = runBlocking {</span>
<span class="fc" id="L90">        val result = client.get(&quot;/default&quot;, multiMapOf(&quot;origin&quot; to &quot;example.org&quot;))</span>
<span class="fc" id="L91">        assertEquals(OK, result.status)</span>
<span class="fc" id="L92">        assertEquals(&quot;example.org&quot;, result.headers[&quot;access-control-allow-origin&quot;])</span>
<span class="pc bpc" id="L93" title="3 of 6 branches missed.">        assert(result.headers[&quot;vary&quot;]?.contains(&quot;Origin&quot;) ?: false)</span>
<span class="fc" id="L94">        assertEquals(&quot;true&quot;, result.headers[&quot;access-control-allow-credentials&quot;])</span>
<span class="fc" id="L95">    }</span>

<span class="fc" id="L97">    @Test fun `Simple CORS request with not allowed method`() = runBlocking {</span>
<span class="fc" id="L98">        val result = client.get(&quot;/only/post&quot;, multiMapOf(&quot;origin&quot; to &quot;example.org&quot;))</span>
<span class="fc" id="L99">        assertEquals(FORBIDDEN, result.status)</span>
<span class="fc" id="L100">        assertEquals(&quot;Not allowed method: GET&quot;, result.body)</span>
<span class="fc" id="L101">    }</span>

<span class="fc" id="L103">    @Test fun `Simple CORS request with exposed headers`() = runBlocking {</span>
<span class="fc" id="L104">        val result = client.get(&quot;/exposed/headers&quot;, multiMapOf(</span>
<span class="fc" id="L105">            &quot;origin&quot; to &quot;example.org&quot;,</span>
<span class="fc" id="L106">            &quot;head&quot; to &quot;exposed header&quot;</span>
        ))
<span class="fc" id="L108">        assertEquals(OK, result.status)</span>
<span class="fc" id="L109">        assertEquals(&quot;example.org&quot;, result.headers[&quot;access-control-allow-origin&quot;])</span>
<span class="pc bpc" id="L110" title="3 of 6 branches missed.">        assert(result.headers[&quot;vary&quot;]?.contains(&quot;Origin&quot;) ?: false)</span>
<span class="fc" id="L111">        assertEquals(&quot;true&quot;, result.headers[&quot;access-control-allow-credentials&quot;])</span>
<span class="fc" id="L112">        assertEquals(&quot;head&quot;, result.headers[&quot;access-control-expose-headers&quot;])</span>
<span class="fc" id="L113">    }</span>

<span class="fc" id="L115">    @Test fun `CORS pre flight with empty request method`() = runBlocking {</span>
<span class="fc" id="L116">        val result = client.options(&quot;/default&quot;, headers = multiMapOfLists(</span>
<span class="fc" id="L117">            &quot;origin&quot; to listOf(&quot;example.org&quot;),</span>
<span class="fc" id="L118">            &quot;access-control-request-method&quot; to emptyList()</span>
        ))
<span class="fc" id="L120">        assertEquals(FORBIDDEN, result.status)</span>
<span class="fc" id="L121">        assertEquals(&quot;access-control-request-method required header not found&quot;, result.body)</span>
<span class="fc" id="L122">    }</span>

<span class="fc" id="L124">    @Test fun `CORS pre flight without request method`() = runBlocking {</span>
<span class="fc" id="L125">        val result = client.options(&quot;/default&quot;, headers = multiMapOf(&quot;origin&quot; to &quot;example.org&quot;))</span>
<span class="fc" id="L126">        assertEquals(FORBIDDEN, result.status)</span>
<span class="fc" id="L127">        assertEquals(&quot;access-control-request-method required header not found&quot;, result.body)</span>
<span class="fc" id="L128">    }</span>

<span class="fc" id="L130">    @Test fun `CORS pre flight`() = runBlocking {</span>
<span class="fc" id="L131">        val result = client.options(&quot;/default&quot;, headers = multiMapOf(</span>
<span class="fc" id="L132">            &quot;origin&quot; to &quot;example.org&quot;,</span>
<span class="fc" id="L133">            &quot;access-control-request-method&quot; to &quot;GET&quot;</span>
        ))
<span class="fc" id="L135">        assertEquals(NO_CONTENT, result.status)</span>
<span class="pc bpc" id="L136" title="3 of 6 branches missed.">        assert(result.bodyString().isEmpty())</span>
<span class="fc" id="L137">    }</span>

<span class="fc" id="L139">    @Test fun `CORS full pre flight`() = runBlocking&lt;Unit&gt; {</span>
<span class="fc" id="L140">        client.options(&quot;/default&quot;, headers = multiMapOf(</span>
<span class="fc" id="L141">            &quot;origin&quot; to (&quot;example.org&quot;),</span>
<span class="fc" id="L142">            &quot;access-control-request-method&quot; to &quot;GET&quot;,</span>
<span class="fc" id="L143">            &quot;access-control-request-headers&quot; to &quot;header1,header2&quot;</span>
<span class="fc" id="L144">        )).apply {</span>
<span class="fc" id="L145">            assertEquals(NO_CONTENT, status)</span>
<span class="pc bpc" id="L146" title="3 of 6 branches missed.">            assert(bodyString().isEmpty())</span>
<span class="fc" id="L147">        }</span>
<span class="fc" id="L148">        client.options(&quot;/cache&quot;, headers = multiMapOf(</span>
<span class="fc" id="L149">            &quot;origin&quot; to &quot;example.org&quot;,</span>
<span class="fc" id="L150">            &quot;access-control-request-method&quot; to &quot;GET&quot;,</span>
<span class="fc" id="L151">            &quot;access-control-request-headers&quot; to &quot;header1,header2&quot;</span>
<span class="fc" id="L152">        )).apply {</span>
<span class="fc" id="L153">            assertEquals(NO_CONTENT, status)</span>
<span class="pc bpc" id="L154" title="3 of 6 branches missed.">            assert(bodyString().isEmpty())</span>
<span class="fc" id="L155">            assertEquals(&quot;10&quot;, headers[&quot;access-control-max-age&quot;])</span>
<span class="fc" id="L156">        }</span>
<span class="fc" id="L157">    }</span>

<span class="fc" id="L159">    @Test fun `CORS pre flight with not allowed method`() = runBlocking {</span>
<span class="fc" id="L160">        val result = client.options(&quot;/only/post&quot;, headers = multiMapOf(</span>
<span class="fc" id="L161">            &quot;origin&quot; to &quot;example.org&quot;,</span>
<span class="fc" id="L162">            &quot;access-control-request-method&quot; to &quot;GET&quot;</span>
        ))
<span class="fc" id="L164">        assertEquals(FORBIDDEN, result.status)</span>
<span class="fc" id="L165">        assertEquals(&quot;Not allowed method: GET&quot;, result.body)</span>
<span class="fc" id="L166">    }</span>

<span class="fc" id="L168">    @Test fun `CORS pre flight with not allowed headers`() = runBlocking {</span>
<span class="fc" id="L169">        val result = client.options(&quot;/allowed/headers&quot;, headers = multiMapOf(</span>
<span class="fc" id="L170">            &quot;origin&quot; to &quot;example.org&quot;,</span>
<span class="fc" id="L171">            &quot;access-control-request-method&quot; to &quot;GET&quot;,</span>
<span class="fc" id="L172">            &quot;access-control-request-headers&quot; to &quot;header1,header2&quot;</span>
        ))
<span class="fc" id="L174">        assertEquals(FORBIDDEN, result.status)</span>
<span class="fc" id="L175">        assertEquals(&quot;Not allowed headers&quot;, result.body)</span>
<span class="fc" id="L176">    }</span>

<span class="fc" id="L178">    @Test fun `CORS pre flight with allowed headers`() = runBlocking {</span>
<span class="fc" id="L179">        val result = client.options(&quot;/allowed/headers&quot;, headers = multiMapOf(</span>
<span class="fc" id="L180">            &quot;origin&quot; to &quot;example.org&quot;,</span>
<span class="fc" id="L181">            &quot;access-control-request-method&quot; to &quot;GET&quot;,</span>
<span class="fc" id="L182">            &quot;access-control-request-headers&quot; to &quot;head&quot;</span>
        ))
<span class="fc" id="L184">        assertEquals(NO_CONTENT, result.status)</span>
<span class="pc bpc" id="L185" title="3 of 6 branches missed.">        assert(result.bodyString().isEmpty())</span>
<span class="fc" id="L186">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>